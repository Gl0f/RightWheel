<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Профіль користувача — RightWheel</title>
  <link rel="icon" href="https://e7.pngegg.com/pngimages/629/366/png-clipart-car-wheel-car-wheel.png" type="image/png" />
  <link rel="stylesheet" href="/static/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

 <header>
    <div class="header-content">
      <div class="logo-nav">
        <div class="logo"><a href="main.html" style="text-decoration: none; color: inherit;"><h1>Right Wheel</h1></a></div>
        <a href="forum.html" class="nav-link-forum">Форум</a>
        <a href="news.html" class="nav-link-forum">Новини</a>
        <a href="market.html" class="nav-link-forum">Автоплощадка</a>
      </div>
    <div class="controls">
  
      <a href="favorites.html" id="showFavoritesBtn" class="btn secondary" style="display:none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="btn-text">Обране</span>
      </a>

      <button id="showLoginModalBtn" class="btn primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Увійти
      </button>

      <div id="userMenuContainer" class="user-menu-container" style="display: none;">
          
          <div id="userMenuTrigger" class="user-menu-trigger">
              <span id="headerUsername" class="header-username">Користувач</span>
              <div class="header-avatar">
                  <img id="headerAvatarImg" src="" alt="Avatar">
              </div>
              <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
          </div>

          <div id="userDropdown" class="user-dropdown">
              <a href="account.html" class="dropdown-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  Мій кабінет
              </a>
              <a href="comparison.html" class="dropdown-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6M12 8v11M6 16v3"/></svg>
                  Список порівнянь
              </a>
              <div class="dropdown-divider"></div>
              <button id="logoutBtnDropdown" class="dropdown-item danger-text">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                  Вийти
              </button>
          </div>
      </div>

    </div>
 </header>
  
  <div class="container">
    <main>
      <div class="breadcrumbs" style="margin-bottom: 20px;">
          <a href="forum.html">Форум</a> <span>/</span>
          <span class="current">Профіль користувача</span>
      </div>

      <div class="account-grid"> <div class="panel-card">
              <div class="panel-header">Профіль</div>
              <div class="panel-body" style="text-align: center;">
                  
                  <div style="margin: 0 auto 15px; width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #E40C2B;">
                      <img id="publicAvatar" src="" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  
                  <h2 id="publicUsername" style="margin: 0; color: #E2E8F0; font-size: 24px;">Завантаження...</h2>
                  <p id="publicJoined" style="color: #718096; font-size: 12px; margin-top: 5px;">...</p>

                  <hr style="border: 0; border-top: 1px solid #2D3748; margin: 20px 0;">

                  <div class="account-stats-grid">
                    <div class="stat-box">
                        <strong id="publicTopics">-</strong>
                        <span>Тем</span>
                    </div>
                    <div class="stat-box">
                        <strong id="publicPosts">-</strong>
                        <span>Постів</span>
                    </div>
                  </div>
              </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 20px;">
              
              <div class="panel-card">
                  <div class="panel-header">Гараж</div>
                  <div class="panel-body">
                      <div style="display: flex; align-items: center; gap: 15px;">
                          <div style="background: #2D3748; padding: 10px; border-radius: 8px; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center;">
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#E40C2B" stroke-width="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 17h2v-6h6.65"/></svg>
                          </div>
                          <div>
                              <span style="display: block; color: #A0AEC0; font-size: 12px; text-transform: uppercase;">Поточний автомобіль</span>
                              <span id="publicCar" style="font-size: 18px; font-weight: 600; color: #E2E8F0;">Пішохід</span>
                          </div>
                      </div>
                      
                      <div style="margin-top: 20px;">
                          <span style="display: block; color: #A0AEC0; font-size: 12px; text-transform: uppercase; margin-bottom: 5px;">Про себе</span>
                          <p id="publicBio" style="color: #E2E8F0; font-size: 14px; line-height: 1.5; background: #2D3748; padding: 15px; border-radius: 6px;">
                              Користувач ще не додав інформацію про себе.
                          </p>
                      </div>
                  </div>
              </div>

              <div class="panel-card">
                  <div class="panel-header">Останні створені теми</div>
                  <div id="publicRecentTopics" class="panel-body" style="padding: 0;">
                      <p style="padding: 20px; color: #A0AEC0;">Завантаження...</p>
                  </div>
              </div>
              <div class="panel-card">
                  <div class="panel-header">Оголошення користувача</div>
                  <div class="panel-body" style="padding: 15px;">
                      <div id="publicUserAds" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                          <p style="color: #A0AEC0;">Завантаження...</p>
                      </div>
                  </div>
              </div>

          </div>
      </div>
    </main>

    

  <div id="infoModal" class="modal-root" style="display:none">
  <div class="modal-back" id="infoModalBack"></div>
  <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
      <h2 id="infoModalTitle" class="modal-title">Повідомлення</h2>
      </div>
      <div class="form-content" style="gap: 20px;">
      <p id="infoModalMessage" style="font-size: 16px; margin: 0;">Текст повідомлення...</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button id="infoModalOkBtn" class="btn primary">OK</button>
      </div>
      </div>
  </div>
  </div>


 <div id="loginModal" class="modal-root" style="display:none">
    <div class="modal-back"></div>
    <div class="modal login-theme"> <div class="modal-header-center">
        <h2 class="modal-title-large">Раді вітати<br>вас знову</h2>
        <button id="closeLoginModalBtn" class="close-btn-abs">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>

      <form id="loginForm" class="form-content sp-form">
        
        <div class="form-group">
          <label for="loginUsername" class="sp-label">Ел. пошта або ім'я користувача</label>
          <input id="loginUsername" type="text" placeholder="Ел. пошта або логін" class="sp-input" required />
        </div>
        
        <div class="form-group">
           <label for="loginPassword" class="sp-label">Пароль</label>
           <input id="loginPassword" type="password" placeholder="Пароль" class="sp-input" required />
        </div>

        <div class="sp-checkbox-wrapper">
            <div class="form-group checkbox-group">
                <input type="checkbox" id="captchaCheck" required />
                <label for="captchaCheck">Я не робот</label>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="consentCheck" required />
                <label for="consentCheck">Згода на обробку даних</label>
            </div>
        </div>
         
        <button class="btn sp-btn-primary full-width" type="submit">Увійти</button>

        <div class="auth-divider">
           <span>або</span>
        </div>

        <div id="googleButtonDiv" style="width: 100%; display: flex; justify-content: center; margin-top: 15px;"></div>

        <div class="modal-footer-link">
            <span style="color: #a7a7a7;">Немає акаунта?</span>
            <a href="#" class="form-link white-link" id="showRegisterBtnFromLogin">Зареєструватися</a>
        </div>
         
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal-root" style="display:none">
    <div class="modal-back"></div>
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Реєстрація в RightWheel</h2>
        <button id="closeRegisterModalBtn" class="btn small secondary" style="margin-left: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <form id="registerForm" class="form-content">
        <div class="form-group">
          <label for="registerUsername">Логін</label>
          <input id="registerUsername" type="text" placeholder="Придумайте логін" required />
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input id="registerEmail" type="email" placeholder="Ваш email" required />
        </div>
        <div class="form-group">
          <label for="registerPassword">Пароль</label>
          <input id="registerPassword" type="password" placeholder="Придумайте пароль" required />
        </div>
        <div class="form-group">
          <label for="registerConfirmPassword">Підтвердження пароля</label>
          <input id="registerConfirmPassword" type="password" placeholder="Повторіть пароль" required />
        </div>
        <div class="form-group">
          <div class="captcha-container">
            <div class="captcha-text">Я не робот</div>
            <input type="checkbox" id="registerCaptchaCheck" required />
            <label for="registerCaptchaCheck">Підтвердити</label>
          </div>
        </div>
        <button class="btn primary full-width" type="submit">Зареєструватися</button>
      </form>

      <div class="modal-footer-link">
        <span>Вже є акаунт?</span>
        <a href="#" class="form-link" id="showLoginBtnFromRegister">Увійти</a>
      </div>

    </div>
  </div>

<script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('id');
            
            // Елементи для виводу помилок
            const profileContainer = document.querySelector('.panel-body');
            const adsContainer = document.getElementById('publicUserAds');

            if (!userId || userId === 'undefined') {
                if(profileContainer) profileContainer.innerHTML = '<p style="color:red">Помилка: ID користувача не знайдено.</p>';
                return;
            }

            // 1. Завантаження Профілю, Статистики та Тем
            loadUserProfile(userId);

            // 2. Завантаження Оголошень (окремо, щоб не блокувати профіль)
            loadUserAds(userId);

            
            async function loadUserProfile(id) {
                try {
                    const response = await fetch(`/api/users/${id}/profile`);
                    if (!response.ok) throw new Error(`Помилка: ${response.status}`);
                    
                    const data = await response.json();

                    // --- Аватар та Інфо ---
                    const imgEl = document.getElementById('publicAvatar');
                    if (imgEl) {
                        if (data.user.avatar_url) {
                            imgEl.src = data.user.avatar_url.startsWith('http') ? data.user.avatar_url : `${data.user.avatar_url}`;
                        } else {
                            const initial = (data.user.username || 'U').charAt(0).toUpperCase();
                            imgEl.src = `https://ui-avatars.com/api/?name=${initial}&background=2D3748&color=fff&size=150`;
                        }
                    }

                    setText('publicUsername', data.user.username);
                    
                    if (data.user.created_at) {
                        const dateObj = new Date(data.user.created_at);
                        setText('publicJoined', 'З нами з ' + dateObj.toLocaleDateString('uk-UA'));
                    }

                    setText('publicCar', data.user.current_car || 'Пішохід');
                    setText('publicBio', data.user.bio || 'Користувач ще не додав інформацію про себе.');
                    
                    // --- Статистика ---
                    setText('publicTopics', data.stats.topic_count || 0);
                    setText('publicPosts', data.stats.post_count || 0);

                    // --- Останні теми ---
                    const topicsContainer = document.getElementById('publicRecentTopics');
                    if (topicsContainer) {
                        if (data.recent_topics && data.recent_topics.length > 0) {
                            topicsContainer.innerHTML = data.recent_topics.map(topic => {
                                const dateStr = new Date(topic.created_at).toLocaleDateString('uk-UA');
                                return `
                                    <div style="padding: 12px 20px; border-bottom: 1px solid #4A5568; display: flex; justify-content: space-between; align-items: center;">
                                        <a href="topic.html?id=${topic.id}" style="color: #E2E8F0; text-decoration: none; font-weight: 500;">${topic.title}</a>
                                        <span style="font-size: 12px; color: #718096;">${dateStr}</span>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            topicsContainer.innerHTML = '<p style="padding: 20px; color: #718096; text-align: center;">Користувач ще не створював тем.</p>';
                        }
                    }

                } catch (error) {
                    console.error("Profile error:", error);
                    if(profileContainer) profileContainer.innerHTML = `<p style="color:red">Не вдалося завантажити профіль.</p>`;
                }
            }

            async function loadUserAds(id) {
                if (!adsContainer) return;
                
                try {
                    const response = await fetch(`/api/users/${id}/ads`);
                    if (!response.ok) throw new Error('Failed to load ads');
                    
                    const ads = await response.json();

                    if (ads && ads.length > 0) {
                        adsContainer.innerHTML = ads.map(ad => {
                            const price = new Intl.NumberFormat('en-US').format(ad.price);
                            const imgUrl = ad.main_image || 'https://via.placeholder.com/300x200?text=No+Photo';
                            
                            return `
                                <a href="market-detail.html?id=${ad.id}" style="text-decoration: none; display: block; background: #2D3748; border: 1px solid #4A5568; border-radius: 6px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <div style="height: 120px; overflow: hidden;">
                                        <img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div style="padding: 10px;">
                                        <div style="color: #38A169; font-weight: 700; font-size: 15px; margin-bottom: 2px;">$ ${price}</div>
                                        <div style="font-size: 13px; font-weight: 500; color: #E2E8F0;">
                                            ${ad.brand_name} ${ad.model_name} ${ad.year}
                                        </div>
                                    </div>
                                </a>
                            `;
                        }).join('');
                    } else {
                        adsContainer.innerHTML = '<p style="color: #718096; grid-column: 1/-1; text-align: center;">Користувач не має активних оголошень.</p>';
                    }
                } catch (error) {
                    console.error("Ads error:", error);
                    adsContainer.innerHTML = '<p style="color: #718096;">Не вдалося завантажити оголошення.</p>';
                }
            }

            // Допоміжна функція для безпечного встановлення тексту
            function setText(id, text) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }
        });
    </script>

  <script src="/static/app.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>